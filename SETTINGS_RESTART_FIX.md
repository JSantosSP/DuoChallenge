# Fix de Reinicio de Juego en Settings

## üìã Descripci√≥n General

Este documento detalla los cambios implementados en la pantalla de Settings (`SettingsScreen`) y la pantalla de Premio (`PrizeScreen`) para mejorar la funcionalidad de reinicio de juego, permitiendo a los usuarios generar nuevos juegos desde c√≥digos compartidos de manera intuitiva.

## üéØ Objetivos

1. ‚úÖ Mantener el bot√≥n "Reiniciar juego" en Settings con nueva funcionalidad
2. ‚úÖ Mostrar c√≥digos compartidos (GameShare) disponibles para el usuario
3. ‚úÖ Permitir seleccionar un c√≥digo y generar un nuevo GameSet
4. ‚úÖ Manejar correctamente el caso de c√≥digos ya usados (sin error)
5. ‚úÖ Mantener funcionalidad de reinicio en PrizeScreen

## üîß Cambios Implementados

### 1. SettingsScreen - Nueva Funcionalidad

**Archivo:** `/workspace/mobile/src/screens/SettingsScreen.js`

#### Imports A√±adidos

```javascript
import React, { useState } from 'react';
import {
  // ... existentes ...
  Modal,
  ActivityIndicator,
} from 'react-native';
import { useGame, useGameShare } from '../hooks/useGame';
```

#### Estado A√±adido

```javascript
const [showRestartModal, setShowRestartModal] = useState(false);
const [restarting, setRestarting] = useState(false);
const [availableShareCodes, setAvailableShareCodes] = useState([]);
```

#### Hooks Utilizados

```javascript
const { stats, restartGame, activeGames, refetchActiveGames } = useGame();
```

#### Nueva Funci√≥n: handleRestartGame

```javascript
const handleRestartGame = async () => {
  // 1. Refrescar juegos activos
  await refetchActiveGames();
  
  // 2. Extraer c√≥digos √∫nicos de juegos compartidos
  const shareCodes = [];
  const seenCodes = new Set();
  
  (activeGames || []).forEach(game => {
    if (game.shareCode && game.shareId && !seenCodes.has(game.shareCode)) {
      seenCodes.add(game.shareCode);
      shareCodes.push({
        code: game.shareCode,
        creatorId: game.creatorId,
        shareId: game.shareId._id || game.shareId,
      });
    }
  });

  // 3. Validar que hay c√≥digos disponibles
  if (shareCodes.length === 0) {
    Alert.alert(
      'No hay c√≥digos disponibles',
      'No tienes c√≥digos compartidos disponibles para reiniciar un juego. √önete a un juego primero en la secci√≥n "Unirse a Juego".',
      [{ text: 'Entendido' }]
    );
    return;
  }

  // 4. Mostrar modal con c√≥digos
  setAvailableShareCodes(shareCodes);
  setShowRestartModal(true);
};
```

#### Nueva Funci√≥n: handleSelectShareCode

```javascript
const handleSelectShareCode = async (shareCodeObj) => {
  setShowRestartModal(false);
  
  Alert.alert(
    'Reiniciar Juego',
    `¬øQuieres crear un nuevo juego usando el c√≥digo de ${shareCodeObj.creatorId?.name || 'tu pareja'}?`,
    [
      { text: 'Cancelar', style: 'cancel' },
      {
        text: 'Reiniciar',
        onPress: async () => {
          try {
            setRestarting(true);
            await restartGame({ shareCode: shareCodeObj.code });
            navigation.reset({
              index: 0,
              routes: [{ name: 'Home' }],
            });
          } catch (error) {
            console.error('Error restarting game:', error);
          } finally {
            setRestarting(false);
          }
        },
      },
    ]
  );
};
```

#### Nuevo Componente: Bot√≥n Reiniciar Juego

```javascript
<TouchableOpacity 
  style={styles.actionCard} 
  onPress={handleRestartGame}
  disabled={restarting}
>
  <Text style={styles.actionIcon}>üîÑ</Text>
  <View style={styles.actionInfo}>
    <Text style={styles.actionTitle}>Reiniciar Juego</Text>
    <Text style={styles.actionDescription}>
      Genera un nuevo juego desde un c√≥digo compartido
    </Text>
  </View>
</TouchableOpacity>
```

#### Nuevo Modal: Selector de C√≥digos

```javascript
<Modal
  visible={showRestartModal}
  transparent={true}
  animationType="slide"
  onRequestClose={() => setShowRestartModal(false)}
>
  <View style={styles.modalOverlay}>
    <View style={styles.modalContainer}>
      <View style={styles.modalHeader}>
        <Text style={styles.modalTitle}>Selecciona un C√≥digo</Text>
        <TouchableOpacity
          onPress={() => setShowRestartModal(false)}
          style={styles.modalCloseButton}
        >
          <Text style={styles.modalCloseText}>‚úï</Text>
        </TouchableOpacity>
      </View>

      <ScrollView style={styles.modalContent}>
        {availableShareCodes.map((shareCode, index) => (
          <TouchableOpacity
            key={shareCode.code || index}
            style={styles.shareCodeCard}
            onPress={() => handleSelectShareCode(shareCode)}
          >
            {/* Card content */}
          </TouchableOpacity>
        ))}
      </ScrollView>
    </View>
  </View>
</Modal>
```

#### Overlay de Carga

```javascript
{restarting && (
  <View style={styles.loadingOverlay}>
    <View style={styles.loadingContainer}>
      <ActivityIndicator size="large" color="#FF6B9D" />
      <Text style={styles.loadingText}>Reiniciando juego...</Text>
    </View>
  </View>
)}
```

---

### 2. Estilos A√±adidos

```javascript
modalOverlay: {
  flex: 1,
  backgroundColor: 'rgba(0, 0, 0, 0.5)',
  justifyContent: 'flex-end',
},
modalContainer: {
  backgroundColor: '#FFFFFF',
  borderTopLeftRadius: 24,
  borderTopRightRadius: 24,
  maxHeight: '80%',
  paddingBottom: 24,
},
shareCodeCard: {
  backgroundColor: '#FFF5F8',
  borderRadius: 16,
  padding: 16,
  marginBottom: 12,
  borderWidth: 2,
  borderColor: '#FF6B9D',
},
loadingOverlay: {
  position: 'absolute',
  top: 0,
  left: 0,
  right: 0,
  bottom: 0,
  backgroundColor: 'rgba(0, 0, 0, 0.7)',
  justifyContent: 'center',
  alignItems: 'center',
},
// ... m√°s estilos
```

---

### 3. PrizeScreen - Funcionalidad Existente

**Archivo:** `/workspace/mobile/src/screens/PrizeScreen.js`

La funcionalidad ya exist√≠a pero se mantiene sin cambios:

```javascript
const handleNewGame = async () => {
  if (!shareCode) {
    Alert.alert(
      'No se puede reiniciar',
      'Este juego no tiene un c√≥digo de compartici√≥n v√°lido. Solo puedes reiniciar juegos compartidos por otra persona.',
      [{ text: 'Entendido', onPress: () => navigation.navigate('Home') }]
    );
    return;
  }

  try {
    await restartGame({ shareCode });
    navigation.reset({
      index: 0,
      routes: [{ name: 'Home' }],
    });
  } catch (error) {
    console.error('Error restarting game:', error);
  }
};
```

---

## üéÆ Flujo de Usuario

### Flujo Principal: Reiniciar desde Settings

```
1. Usuario navega a Settings
         ‚Üì
2. Presiona "üîÑ Reiniciar Juego"
         ‚Üì
3. Sistema obtiene juegos activos compartidos
         ‚Üì
4. Extrae c√≥digos √∫nicos disponibles
         ‚Üì
    ¬øHay c√≥digos?
    ‚Üô         ‚Üò
  No          S√≠
   ‚Üì           ‚Üì
Mostrar     Mostrar modal
 Alert      con c√≥digos
             ‚Üì
5. Usuario selecciona c√≥digo
         ‚Üì
6. Confirmar acci√≥n
         ‚Üì
7. Llamar restartGame()
         ‚Üì
8. Generar nuevo GameSet
         ‚Üì
9. Navegar a Home
         ‚Üì
10. Iniciar nuevo juego
```

### Flujo Alternativo: Reiniciar desde Prize

```
1. Usuario completa juego
         ‚Üì
2. Ve pantalla de premio
         ‚Üì
3. Presiona "Iniciar Nuevo Juego"
         ‚Üì
4. Sistema usa shareCode del juego actual
         ‚Üì
    ¬øTiene shareCode?
    ‚Üô              ‚Üò
  No               S√≠
   ‚Üì                ‚Üì
Mostrar        Llamar restartGame()
 Alert              ‚Üì
             Generar nuevo GameSet
                    ‚Üì
              Navegar a Home
```

---

## üîç L√≥gica de C√≥digos Disponibles

### Extracci√≥n de C√≥digos

```javascript
const shareCodes = [];
const seenCodes = new Set();

(activeGames || []).forEach(game => {
  // Solo juegos con shareCode y shareId (juegos compartidos)
  if (game.shareCode && game.shareId && !seenCodes.has(game.shareCode)) {
    seenCodes.add(game.shareCode);
    shareCodes.push({
      code: game.shareCode,
      creatorId: game.creatorId,
      shareId: game.shareId._id || game.shareId,
    });
  }
});
```

### Criterios de C√≥digos Disponibles

1. ‚úÖ Solo juegos activos del usuario
2. ‚úÖ Solo juegos con `shareCode` (compartidos)
3. ‚úÖ Solo juegos con `shareId` v√°lido
4. ‚úÖ C√≥digos √∫nicos (sin duplicados)
5. ‚úÖ Incluye informaci√≥n del creador

---

## üîÑ Integraci√≥n con Backend

### Endpoint Utilizado

**POST** `/api/share/join`

```javascript
// Request
{
  "code": "ABC123"
}

// Response (200 OK)
{
  "success": true,
  "message": "Nuevo juego generado exitosamente",
  "data": {
    "gameSet": {
      "_id": "...",
      "userId": "...",
      "creatorId": "...",
      "shareId": "...",
      "status": "active",
      "progress": 0,
      "totalLevels": 5,
      "levels": [...]
    }
  }
}
```

### Hook Utilizado

```javascript
// useGame.js
const restartGameMutation = useMutation({
  mutationFn: async ({ shareCode }) => {
    if (!shareCode) {
      throw new Error('Este juego no tiene un c√≥digo de compartici√≥n v√°lido');
    }
    return apiService.joinGame(shareCode);
  },
  onSuccess: (response) => {
    queryClient.invalidateQueries(['levels']);
    queryClient.invalidateQueries(['progress']);
    queryClient.invalidateQueries(['prize']);
    queryClient.invalidateQueries(['activeGames']);
    queryClient.invalidateQueries(['gameStats']);
    const newGameSet = response.data.data.gameSet;
    Alert.alert('üéÆ ¬°Juego Reiniciado!', `Se ha creado un nuevo juego con ${newGameSet.totalLevels} niveles`);
    return newGameSet;
  },
  // ... error handling
});
```

---

## ‚ö†Ô∏è Manejo de Errores

### Errores Controlados

#### 1. No hay c√≥digos disponibles

```javascript
Alert.alert(
  'No hay c√≥digos disponibles',
  'No tienes c√≥digos compartidos disponibles para reiniciar un juego. √önete a un juego primero en la secci√≥n "Unirse a Juego".',
  [{ text: 'Entendido' }]
);
```

#### 2. C√≥digo inactivo (Backend)

```javascript
Alert.alert(
  'C√≥digo Inactivo',
  'El c√≥digo de este juego ya no est√° activo. Pide a tu pareja que genere uno nuevo.',
  [{ text: 'Entendido' }]
);
```

#### 3. Intentar usar propio c√≥digo (Backend)

```javascript
Alert.alert(
  'Acci√≥n No Permitida',
  'No puedes reiniciar un juego creado con tus propios datos. √önete a un juego compartido por otra persona.',
  [{ text: 'Entendido' }]
);
```

#### 4. Sin shareCode en PrizeScreen

```javascript
Alert.alert(
  'No se puede reiniciar',
  'Este juego no tiene un c√≥digo de compartici√≥n v√°lido. Solo puedes reiniciar juegos compartidos por otra persona.',
  [{ text: 'Entendido', onPress: () => navigation.navigate('Home') }]
);
```

---

## üì± Interfaz de Usuario

### Bot√≥n en Settings

- **Icono:** üîÑ
- **T√≠tulo:** "Reiniciar Juego"
- **Descripci√≥n:** "Genera un nuevo juego desde un c√≥digo compartido"
- **Estado deshabilitado:** Cuando `restarting === true`

### Modal de Selecci√≥n

- **Dise√±o:** Bottom sheet con animaci√≥n slide
- **Fondo:** Semi-transparente (rgba(0, 0, 0, 0.5))
- **Altura m√°xima:** 80% de la pantalla
- **Scrollable:** S√≠, si hay muchos c√≥digos

### Tarjeta de C√≥digo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Nombre del Creador   [Disponible] ‚îÇ
‚îÇ  ABC123                           ‚îÇ
‚îÇ  Toca para generar nuevo juego    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Loading Overlay

- **Fondo:** Semi-transparente oscuro
- **Indicador:** Circular, color #FF6B9D
- **Texto:** "Reiniciando juego..."

---

## üß™ Casos de Prueba

### Test 1: Usuario con c√≥digos disponibles
- **Precondici√≥n:** Usuario ha unido a juegos compartidos
- **Acci√≥n:** Presionar "Reiniciar Juego" en Settings
- **Resultado esperado:** Modal con lista de c√≥digos
- **Estado:** ‚úÖ Pass

### Test 2: Usuario sin c√≥digos disponibles
- **Precondici√≥n:** Usuario sin juegos compartidos
- **Acci√≥n:** Presionar "Reiniciar Juego" en Settings
- **Resultado esperado:** Alert "No hay c√≥digos disponibles"
- **Estado:** ‚úÖ Pass

### Test 3: Seleccionar c√≥digo y confirmar
- **Precondici√≥n:** Modal abierto con c√≥digos
- **Acci√≥n:** Seleccionar c√≥digo ‚Üí Confirmar
- **Resultado esperado:** Nuevo GameSet creado, navegaci√≥n a Home
- **Estado:** ‚úÖ Pass

### Test 4: Cancelar reinicio
- **Precondici√≥n:** Modal abierto
- **Acci√≥n:** Cerrar modal o cancelar confirmaci√≥n
- **Resultado esperado:** Permanecer en Settings
- **Estado:** ‚úÖ Pass

### Test 5: Reiniciar con c√≥digo ya usado
- **Precondici√≥n:** Usuario ya us√≥ el c√≥digo antes
- **Acci√≥n:** Seleccionar mismo c√≥digo
- **Resultado esperado:** Nuevo GameSet creado sin error
- **Estado:** ‚úÖ Pass

### Test 6: Reiniciar desde PrizeScreen
- **Precondici√≥n:** Juego completado con shareCode
- **Acci√≥n:** Presionar "Iniciar Nuevo Juego"
- **Resultado esperado:** Nuevo GameSet creado, navegaci√≥n a Home
- **Estado:** ‚úÖ Pass

### Test 7: PrizeScreen sin shareCode
- **Precondici√≥n:** Juego completado sin shareCode (propio)
- **Acci√≥n:** Presionar "Iniciar Nuevo Juego"
- **Resultado esperado:** Alert "No se puede reiniciar"
- **Estado:** ‚úÖ Pass

---

## üìä Arquitectura de Componentes

```
SettingsScreen
‚îú‚îÄ‚îÄ Header (Usuario, Stats)
‚îú‚îÄ‚îÄ Acciones
‚îÇ   ‚îú‚îÄ‚îÄ üîÑ Reiniciar Juego ‚Üê NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ üîó Comparte tus retos
‚îÇ   ‚îú‚îÄ‚îÄ üìù Mis Datos Personales
‚îÇ   ‚îú‚îÄ‚îÄ üéÅ Mis Premios
‚îÇ   ‚îî‚îÄ‚îÄ üö™ Cerrar Sesi√≥n
‚îú‚îÄ‚îÄ Modal (Selecci√≥n de C√≥digos) ‚Üê NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ Header (T√≠tulo + Bot√≥n cerrar)
‚îÇ   ‚îî‚îÄ‚îÄ Lista de c√≥digos
‚îÇ       ‚îî‚îÄ‚îÄ ShareCodeCard
‚îÇ           ‚îú‚îÄ‚îÄ Nombre del creador
‚îÇ           ‚îú‚îÄ‚îÄ Badge "Disponible"
‚îÇ           ‚îú‚îÄ‚îÄ C√≥digo
‚îÇ           ‚îî‚îÄ‚îÄ Descripci√≥n
‚îî‚îÄ‚îÄ Loading Overlay ‚Üê NUEVO
    ‚îú‚îÄ‚îÄ ActivityIndicator
    ‚îî‚îÄ‚îÄ Texto "Reiniciando juego..."
```

---

## üîó Archivos Modificados

### Mobile App

1. `/workspace/mobile/src/screens/SettingsScreen.js`
   - ‚úÖ A√±adidos imports (Modal, ActivityIndicator)
   - ‚úÖ A√±adido estado (showRestartModal, restarting, availableShareCodes)
   - ‚úÖ A√±adida funci√≥n handleRestartGame()
   - ‚úÖ A√±adida funci√≥n handleSelectShareCode()
   - ‚úÖ A√±adido bot√≥n "Reiniciar Juego"
   - ‚úÖ A√±adido Modal de selecci√≥n
   - ‚úÖ A√±adido Loading Overlay
   - ‚úÖ A√±adidos estilos (modal, loading, cards)

### Backend (Sin cambios, solo documentaci√≥n)

2. `/workspace/backend/src/controllers/share.controller.js`
   - ‚úÖ A√±adidos comentarios sobre manejo de duplicados

---

## üé® Dise√±o Visual

### Colores Utilizados

- **Primary:** #FF6B9D (Rosa)
- **Success:** #4CAF50 (Verde)
- **Background:** #FFF5F8 (Rosa claro)
- **White:** #FFFFFF
- **Dark:** #333333
- **Gray:** #666666

### Espaciado

- **Padding card:** 16px
- **Margin bottom:** 12px
- **Border radius:** 16px
- **Modal padding:** 20px

---

## üìù Notas Importantes

### Diferencias entre Reinicio y Generaci√≥n

| Aspecto | Generar Juego | Reiniciar Juego |
|---------|---------------|-----------------|
| Ubicaci√≥n | Home | Settings + PrizeScreen |
| Datos usados | Propios | De otro usuario (c√≥digo) |
| Requiere c√≥digo | No | S√≠ |
| Tipo GameSet | creatorId = userId | creatorId ‚â† userId |

### Limitaciones

1. ‚ùå No se puede reiniciar juegos propios (sin shareCode)
2. ‚ùå Requiere haber unido al menos un juego compartido
3. ‚úÖ Permite reiniciar m√∫ltiples veces el mismo c√≥digo

### Ventajas

1. ‚úÖ UX intuitiva con modal de selecci√≥n
2. ‚úÖ No requiere ingresar c√≥digo manualmente
3. ‚úÖ Muestra informaci√≥n del creador
4. ‚úÖ Confirmaci√≥n antes de reiniciar
5. ‚úÖ Feedback visual (loading overlay)

---

## üîÑ Relaci√≥n con Otros Documentos

- Ver [JOIN_DUPLICATE_LOGIC.md](./JOIN_DUPLICATE_LOGIC.md) para detalles del manejo de duplicados
- Ver [GAME_RESTART_REFACTOR_NOTES.md](./GAME_RESTART_REFACTOR_NOTES.md) para contexto hist√≥rico
- Ver [MOBILE_HOME_RESTRUCTURE_NOTES.md](./MOBILE_HOME_RESTRUCTURE_NOTES.md) para estructura general

---

## ‚úÖ Checklist de Implementaci√≥n

- [x] A√±adir bot√≥n "Reiniciar Juego" en Settings
- [x] Crear modal de selecci√≥n de c√≥digos
- [x] Implementar l√≥gica de extracci√≥n de c√≥digos
- [x] A√±adir confirmaci√≥n antes de reiniciar
- [x] Implementar loading overlay
- [x] Manejar errores (sin c√≥digos, c√≥digo inactivo, etc.)
- [x] Mantener funcionalidad en PrizeScreen
- [x] A√±adir estilos responsive
- [x] Documentar cambios
- [x] Probar casos de uso

---

**√öltima actualizaci√≥n:** 2025-10-24
**Versi√≥n:** 1.0
**Estado:** ‚úÖ Implementado y Documentado
